# フィーチャー完成時チェックプロンプト

このプロンプトを Claude Code に投げて、実装完了時の品質チェックを行ってください。

---

## プロンプト

以下の項目について、実装したフィーチャーを確認してください。

### 🔍 手動レビューが必要な項目（自動化困難）

#### 1. データ整合性・同期問題
- [ ] 競合状態（race condition）が発生する可能性のあるコードはないか？
- [ ] デッドロックのリスクがある並行処理はないか？
- [ ] 非効率なデータベースクエリ（N+1問題等）はないか？
- [ ] 楽観的ロック/悲観的ロックの選択は適切か？

#### 2. メモリ・パフォーマンス問題
- [ ] イベントリスナーやタイマーの適切なクリーンアップがされているか？
- [ ] 大量のオブジェクト生成や保持によるメモリリークの可能性はないか？
- [ ] 無限ループになる可能性のあるロジックはないか？
- [ ] React の無限再レンダーループのリスクはないか？

#### 3. Supabase 固有のセキュリティ
- [ ] Row Level Security (RLS) ポリシーは適切に設定されているか？
- [ ] クライアントサイドで機密情報へのアクセスを試みていないか？
- [ ] Supabase のレスポンス型を適切にアサーションしているか？

#### 4. ビジネスロジック
- [ ] 計算責任の一元化原則に従っているか？
  - 各フィーチャーが自身のドメインの計算に責任を持つ
  - 他のフィーチャーは計算済みデータを参照（再計算禁止）
- [ ] エッジケースや異常系の処理が実装されているか？
- [ ] ユーザーの期待する動作と実装が一致しているか？

#### 5. Next.js/SSR 特有の問題
- [ ] 'use client'/'use server' ディレクティブは適切か？
- [ ] Server Component 内でクライアント専用 API を使用していないか？
- [ ] Hydration エラーが発生する可能性のあるコードはないか？
- [ ] 環境変数の使用は適切か（NEXT_PUBLIC_ プレフィックス）？

### 🎯 実装品質の最終確認

```bash
# 以下のコマンドを実行して、全てがパスすることを確認
pnpm validate:all

# 個別チェック（問題がある場合のみ）
pnpm check:boundaries   # フィーチャー境界違反
pnpm typecheck          # 型エラー
pnpm lint               # ESLint違反
pnpm test               # テスト
pnpm build              # ビルド成功
```

### 📝 レビュー観点

1. **セキュリティ**: ユーザー入力の検証、SQLインジェクション対策、XSS対策
2. **パフォーマンス**: 不要な再レンダー、重い計算の最適化、適切なメモ化
3. **保守性**: コードの可読性、適切な抽象化、ドキュメント
4. **テスタビリティ**: テストが書きやすい設計、モックしやすい構造
5. **エラーハンドリング**: 適切なエラー処理、ユーザーへのフィードバック

### ⚠️ 特に注意すべきパターン

```typescript
// ❌ 危険：オブジェクトインジェクション（手動チェック必要）
const value = obj[userInput];  // userInputが信頼できない場合

// ❌ 危険：SQL構築（必ずパラメータ化クエリを使用）
const query = `SELECT * FROM users WHERE id = ${userId}`;

// ❌ 危険：無限ループの可能性
useEffect(() => {
  setState(value);  // stateがdependencyにある場合
}, [state]);

// ❌ 危険：メモリリーク
useEffect(() => {
  const timer = setInterval(() => {}, 1000);
  // return () => clearInterval(timer); が必要
}, []);
```

---

## 使い方

1. フィーチャー実装完了時にこのプロンプトをコピー
2. Claude Code に貼り付けて実行
3. 指摘された問題を修正
4. `pnpm validate:all` が全てパスすることを確認
5. PR作成またはマージ

## 自動化されている項目（手動チェック不要）

以下は ESLint ルールで自動検出されるため、手動チェック不要：

- ✅ eval() の使用
- ✅ 非同期処理のエラーハンドリング
- ✅ null/undefined 参照
- ✅ React Hooks のルール違反
- ✅ 型の不一致
- ✅ console.log の残存
- ✅ フィーチャー境界違反
- ✅ 未使用変数
- ✅ 複雑度の高いコード