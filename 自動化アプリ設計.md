# Plan C 全自動化アプリ設計書

## 🎯 目標

月14日に**自動で指標を取得→判定→通知**するアプリを構築

---

## 📊 データ取得の可能性

### ✅ 自動取得可能（yfinance API）

| 指標 | ティッカー | 備考 |
|------|-----------|------|
| **VIX** | `^VIX` | リアルタイム取得可能 |
| **日経平均** | `^N225` | リアルタイム取得可能 |
| **S&P500** | `^GSPC` | リアルタイム取得可能 |
| **3ヶ月前株価** | 履歴データ | yfinanceで過去データ取得可能 |

### ⚠️ 自動取得困難（バフェット指数）

| データ | API | 状況 |
|--------|-----|------|
| **日本バフェット指数** | FRED: `DDDM01JPA156NWDB` | ❌ 2020年まで（更新停止） |
| **米国バフェット指数** | FRED: 類似データあり | ❌ リアルタイム更新なし |
| **nikkeiyosoku.com** | 公式API | ❌ 提供なし（スクレイピングは規約違反） |

**結論**: バフェット指数のみ手動入力が必要

---

## 🏗️ アプリアーキテクチャ（3段階）

### Phase 1: 準自動化Webアプリ（推奨開始点）

**機能**:
- VIX・株価を自動取得
- バフェット指数のみ手動入力（月1回、1分）
- 自動判定＋結果表示

**技術スタック**:
```
Python (Flask/FastAPI) + yfinance
+ React/Next.js (フロントエンド)
または Streamlit（最速実装）
```

**所要時間**: 2-3日

---

### Phase 2: 自動通知機能追加

**機能**:
- Phase 1 + 毎月14日10:00に自動実行
- 判定結果をメール/LINE/Slackで通知
- Google Sheets自動記録

**技術スタック**:
```
Phase 1 + GitHub Actions（スケジューラー）
+ SendGrid/Gmail API（メール通知）
または LINE Notify API（LINE通知）
```

**所要時間**: +1日

---

### Phase 3: 完全自動化（バフェット指数も自動）

**機能**:
- バフェット指数の代替データソースを使用
  - FRED APIで時価総額＋GDPを取得して計算
  - または四半期ごとのWorld Bank APIデータ使用
- 完全無人実行

**技術スタック**:
```
Phase 2 + pandas-datareader (FRED)
または wbgapi (World Bank)
```

**課題**: 
- データ更新頻度が月次でない（四半期ごと）
- 正確性がnikkeiyosoku.comより劣る可能性

**所要時間**: +2日

---

## 💻 Phase 1 実装例（Streamlit）

### 1. インストール

```bash
pip install streamlit yfinance pandas fredapi
```

### 2. アプリコード (`plan_c_app.py`)

```python
import streamlit as st
import yfinance as yf
import pandas as pd
from datetime import datetime, timedelta

# アプリタイトル
st.title("Plan C 暴落判定アプリ")
st.write("毎月14日に実行してください")

# 日付
today = datetime.now()
three_months_ago = today - timedelta(days=90)

st.subheader("📊 自動取得データ")

# VIX取得
@st.cache_data(ttl=3600)
def get_vix():
    vix = yf.Ticker("^VIX")
    data = vix.history(period="1d")
    return data['Close'].iloc[-1] if not data.empty else None

vix_value = get_vix()
vix_pass = vix_value > 30 if vix_value else False

col1, col2 = st.columns(2)
with col1:
    st.metric("VIX（恐怖指数）", f"{vix_value:.2f}" if vix_value else "取得失敗")
with col2:
    st.write("✅ TRUE" if vix_pass else "❌ FALSE")
    st.write("基準: >30")

# 株価取得（3ヶ月前比）
@st.cache_data(ttl=3600)
def get_stock_change(ticker, name):
    stock = yf.Ticker(ticker)
    hist = stock.history(period="6mo")
    
    if len(hist) < 60:
        return None, None
    
    current_price = hist['Close'].iloc[-1]
    past_price = hist['Close'].iloc[-60]  # 約3ヶ月前
    change_pct = ((current_price - past_price) / past_price) * 100
    
    return change_pct, current_price

nikkei_change, nikkei_price = get_stock_change("^N225", "日経平均")
sp500_change, sp500_price = get_stock_change("^GSPC", "S&P500")

nikkei_pass = nikkei_change <= -20 if nikkei_change else False
sp500_pass = sp500_change <= -20 if sp500_change else False
stock_pass = nikkei_pass or sp500_pass

col1, col2 = st.columns(2)
with col1:
    st.metric(
        "日経平均（3ヶ月前比）", 
        f"{nikkei_change:+.2f}%" if nikkei_change else "取得失敗",
        f"現在: {nikkei_price:,.0f}円" if nikkei_price else ""
    )
with col2:
    st.write("✅ TRUE" if nikkei_pass else "❌ FALSE")
    st.write("基準: ≦-20%")

col1, col2 = st.columns(2)
with col1:
    st.metric(
        "S&P500（3ヶ月前比）", 
        f"{sp500_change:+.2f}%" if sp500_change else "取得失敗",
        f"現在: {sp500_price:,.2f}" if sp500_price else ""
    )
with col2:
    st.write("✅ TRUE" if sp500_pass else "❌ FALSE")
    st.write("基準: ≦-20%")

st.divider()

# バフェット指数（手動入力）
st.subheader("📝 手動入力データ")

col1, col2 = st.columns(2)
with col1:
    buffett_jp = st.number_input(
        "日本バフェット指数（%）", 
        min_value=0.0, 
        max_value=300.0, 
        value=120.0,
        help="https://nikkeiyosoku.com/buffett/"
    )
with col2:
    buffett_us = st.number_input(
        "米国バフェット指数（%）", 
        min_value=0.0, 
        max_value=300.0, 
        value=180.0,
        help="https://nikkeiyosoku.com/buffett_us/"
    )

buffett_avg = (buffett_jp + buffett_us) / 2
buffett_pass = buffett_avg < 80

st.metric("バフェット指数平均", f"{buffett_avg:.1f}%")
st.write("✅ TRUE" if buffett_pass else "❌ FALSE")
st.write("基準: <80%")

st.divider()

# 総合判定
st.subheader("🎯 総合判定")

all_conditions = [
    ("VIX > 30", vix_pass),
    ("バフェット平均 < 80%", buffett_pass),
    ("株価下落 ≧ 20%", stock_pass)
]

for condition, result in all_conditions:
    st.write(f"{'✅' if result else '❌'} {condition}")

final_result = all(result for _, result in all_conditions)

if final_result:
    st.success("🚨 暴落条件成立！追加300,000円を投資してください。")
    st.balloons()
else:
    st.info("✅ 通常月です。15日の自動買付300,000円のみ実行されます。")

# 記録用データ
st.divider()
st.subheader("📋 記録用データ")

record = {
    "年月": today.strftime("%Y-%m"),
    "VIX": f"{vix_value:.2f}" if vix_value else "N/A",
    "バフェット日本": f"{buffett_jp:.1f}%",
    "バフェット米国": f"{buffett_us:.1f}%",
    "バフェット平均": f"{buffett_avg:.1f}%",
    "日経平均変動": f"{nikkei_change:+.2f}%" if nikkei_change else "N/A",
    "S&P500変動": f"{sp500_change:+.2f}%" if sp500_change else "N/A",
    "判定": "暴落追加" if final_result else "通常"
}

st.json(record)

# CSV出力ボタン
if st.button("📥 記録をダウンロード"):
    df = pd.DataFrame([record])
    csv = df.to_csv(index=False, encoding='utf-8-sig')
    st.download_button(
        label="CSVダウンロード",
        data=csv,
        file_name=f"plan_c_record_{today.strftime('%Y%m')}.csv",
        mime="text/csv"
    )
```

### 3. 実行方法

```bash
streamlit run plan_c_app.py
```

ブラウザで自動的に開く: http://localhost:8501

---

## 📱 Phase 2: 自動通知機能の追加

### GitHub Actions設定（`.github/workflows/monthly_check.yml`）

```yaml
name: Plan C Monthly Check

on:
  schedule:
    # 毎月14日 10:00 JST (= 1:00 UTC)
    - cron: '0 1 14 * *'
  workflow_dispatch:  # 手動実行も可能

jobs:
  check-crash:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install yfinance pandas requests
      
      - name: Run crash detection
        env:
          LINE_TOKEN: ${{ secrets.LINE_TOKEN }}
        run: |
          python scripts/auto_check.py
```

### 自動判定スクリプト（`scripts/auto_check.py`）

```python
import yfinance as yf
from datetime import datetime, timedelta
import requests
import os

def get_vix():
    vix = yf.Ticker("^VIX")
    data = vix.history(period="1d")
    return data['Close'].iloc[-1] if not data.empty else None

def get_stock_change(ticker):
    stock = yf.Ticker(ticker)
    hist = stock.history(period="6mo")
    current = hist['Close'].iloc[-1]
    past = hist['Close'].iloc[-60]
    return ((current - past) / past) * 100

def send_line_notification(message):
    token = os.environ.get('LINE_TOKEN')
    if not token:
        print("LINE_TOKEN not set")
        return
    
    url = 'https://notify-api.line.me/api/notify'
    headers = {'Authorization': f'Bearer {token}'}
    data = {'message': message}
    requests.post(url, headers=headers, data=data)

# データ取得
vix = get_vix()
nikkei = get_stock_change("^N225")
sp500 = get_stock_change("^GSPC")

# 判定（バフェット指数は手動入力が必要なため、暫定値）
vix_pass = vix > 30 if vix else False
stock_pass = (nikkei <= -20) or (sp500 <= -20)

# 通知メッセージ作成
message = f"""
Plan C 月次チェック ({datetime.now().strftime('%Y-%m-%d')})

VIX: {vix:.2f} {'✅' if vix_pass else '❌'}
日経平均: {nikkei:+.2f}% {'✅' if nikkei <= -20 else '❌'}
S&P500: {sp500:+.2f}% {'✅' if sp500 <= -20 else '❌'}

⚠️ バフェット指数を手動で確認してください:
https://nikkeiyosoku.com/buffett/

{'🚨 暴落の可能性あり！' if (vix_pass and stock_pass) else '✅ 通常月の可能性が高い'}
"""

print(message)
send_line_notification(message)
```

---

## 🔔 通知方法の選択肢

### 1. LINE Notify（最簡単）

**セットアップ（5分）**:
1. https://notify-bot.line.me/ でトークン取得
2. GitHub Secretsに `LINE_TOKEN` を設定
3. 完了

**コスト**: 無料

---

### 2. メール通知（Gmail API）

**セットアップ（15分）**:
1. Google Cloud Consoleでプロジェクト作成
2. Gmail API有効化
3. 認証情報取得
4. GitHub Secretsに設定

**コスト**: 無料（1日500通まで）

---

### 3. Slack通知

**セットアップ（10分）**:
1. Slack Appを作成
2. Incoming Webhooks URL取得
3. GitHub Secretsに設定

**コスト**: 無料

---

## 📅 開発スケジュール

### クイックスタート（3日）

| 日 | 作業 | 所要時間 |
|---|------|---------|
| **1日目** | Phase 1: Streamlitアプリ開発 | 3時間 |
| **2日目** | Phase 2: GitHub Actions設定 | 2時間 |
| **3日目** | LINE Notify統合＋テスト | 1時間 |

**合計**: 6時間の実装で自動通知まで完成

---

### 完全版（1週間）

| 日 | 作業 | 所要時間 |
|---|------|---------|
| **1-3日目** | クイックスタート | 6時間 |
| **4日目** | Next.js/ReactでUI改善 | 4時間 |
| **5日目** | Google Sheets API統合 | 3時間 |
| **6日目** | エラーハンドリング＋ログ | 2時間 |
| **7日目** | デプロイ＋ドキュメント | 2時間 |

**合計**: 17時間で完全版完成

---

## 💰 コスト

| サービス | 用途 | 月額 |
|---------|------|------|
| **GitHub Actions** | スケジューラー | 無料（2,000分/月） |
| **yfinance API** | データ取得 | 無料 |
| **LINE Notify** | 通知 | 無料 |
| **Streamlit Community Cloud** | ホスティング | 無料 |

**合計**: **完全無料**

---

## 🚀 今すぐ始める（最短1時間）

### ステップ1: Python環境準備（10分）

```bash
# Python 3.9以上が必要
python --version

# 仮想環境作成
python -m venv venv
source venv/bin/activate  # Macの場合

# パッケージインストール
pip install streamlit yfinance pandas
```

### ステップ2: アプリ作成（5分）

```bash
# ファイル作成
touch plan_c_app.py

# 上記のコード例をコピペ
```

### ステップ3: 実行（1分）

```bash
streamlit run plan_c_app.py
```

→ ブラウザで http://localhost:8501 を開く

### ステップ4: テスト（5分）

```
1. VIX、日経平均、S&P500が自動表示されることを確認
2. バフェット指数を手動入力
3. 判定結果を確認
4. 記録をCSVダウンロード
```

---

## 🎯 推奨実装プラン

### あなたへの推奨：**Phase 1（準自動化）からスタート**

**理由**:
1. **バフェット指数のリアルタイムAPIがない**
   - 月1回、2つの数字を入力するだけ（1分）
   - 完全自動化よりも正確（公式サイトの最新データ）

2. **Phase 1でも十分な自動化**
   - VIX・株価は自動取得
   - 判定は自動
   - 記録もワンクリック

3. **実装が早い（1時間）**
   - 今日から使える
   - エラーリスクが低い

4. **将来の拡張が容易**
   - Phase 2（自動通知）は1日で追加可能
   - Phase 3（完全自動化）も検討可能

---

## 📝 次のステップ

### 今すぐ実装を始める場合

1. ✅ このファイルを保存
2. ✅ Python環境を準備
3. ✅ `plan_c_app.py` を作成
4. ✅ `streamlit run plan_c_app.py`
5. ✅ 毎月14日10:00に実行

### Claude Codeに実装を依頼する場合

「Phase 1のStreamlitアプリを実装してください」と指示すれば：
- 完全なコードを生成
- 必要なファイル構成を作成
- 実行方法をガイド

---

**要約**: Yahoo Finance API（yfinance）でVIX・株価は完全自動取得可能。バフェット指数のみ公式APIがないため手動入力推奨（月1回1分）。Phase 1アプリなら1時間で実装完了し、今日から使えます。
